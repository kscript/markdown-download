import merge from"webpack-merge";import md5 from"md5";import html2markdown from"html-to-md";import"mathjax/es5/tex-svg";import{query,getExt,getText,getUrl,queryAll,insertAfter,getAttribute,formatDate,exec,formatName}from"./utils";const replace=(e,t)=>(t="function"==typeof t?t:e=>e,e.replace(/\$\{(.*?)\}/g,((e,n)=>t(n.replace(/(^\s+|\s+$)/g,""))))),setInfo=(e,t)=>(e=Object.assign({now:formatDate("yyyy-MM-dd HH:mm:ss"),copyright:!1,url:location.href,description:"转载",tag:[]},e instanceof Object?e:{}),replace((t="string"==typeof t?t:"---\n        title: ${title}\n        date: ${now}\n        copyright: ${copyright}\n        author: ${author}\n        home: ${home}\n        origin: ${origin}\n        url: ${url}\n        tag: ${tag}\n        categories: ${categories}\n        description: ${description}\n    ---\n    ").replace(/\n\s+/g,"\n"),(t=>void 0===e[t]?"":Array.isArray(e[t])?"\n  - "+e[t].join("\n  - "):e[t]))),formatCopyRight=(e,{retain:t,copyright:n})=>{const r=t?"> 当前文档由 [markdown文档下载插件](https://github.com/kscript/markdown-download) 下载, 原文链接: [${title}](${url})  ":n;return"string"==typeof r?"\n\n"+replace(r,(t=>e[t]||""))+"\n\n":""},getMarkdown=e=>e.innerHTML;export const tex2svg=e=>e.replace(/<ztext>(.*?)<\/ztext>/g,((e,t)=>{const n=decodeURIComponent(t),r=MathJax.tex2svg(n);return r.setAttribute("data-tex",n),r.style.display="inline",r.outerHTML}));const formatParams=(e,t,n)=>(t=t instanceof Object?t:{},{options:e=merge({},{br:!1,code:!1,link:!0,lazyKey:"data-src",origin:"",selectors:{}},e instanceof Object?e:{},t),customOptions:t,hook:n=n instanceof Object?n:{}}),getContainer=e=>{if(e){if("string"==typeof e){const t=document.createElement("div");return t.innerHTML=e,t}return e instanceof Node?e:document}return document};export const formatMarkdownBody=(e,t,n,r)=>{const o=query(t.body,e).cloneNode(!0);if(queryAll(t.copyBtn,o).map((e=>e.parentElement.removeChild(e))),queryAll("[data-id]",o).map((e=>e.removeAttribute("data-id"))),t.invalid&&queryAll(t.invalid,o).map((e=>e.parentElement.removeChild(e))),t.unpack&&queryAll(t.unpack,o).map((e=>{const t=document.createElement("span");t.innerHTML=e.innerHTML,insertAfter(document.createElement("br"),e),e.parentElement.replaceChild(t,e)})),t.tag){const e=[];queryAll(t.tag).map((t=>{e.push(t.innerText.replace(/(^[\n\s]+|[\n\s]+$)/g,""))})),n.context.tag=e}return n.link&&queryAll("a",o).map((e=>e.href=e.title)),n.code&&queryAll("code",o).map((e=>{const t=n.br||/copyable/.test(e.className)?"\n":"",r=e.getAttribute("lang")||(e.className.split("-")||{})[1]||"",o="```"+(r?" "+r:"")+t+e.innerText+t+"```"+t;e.parentElement.replaceChild(document.createTextNode(o),e)})),o};const extract=async(e,t,n,r)=>{const{origin:o,context:a,localOptions:i={}}=n,c=getText(t.title)||document.title,l=c.replace(/[\\\/\?<>:'\*\|]/g,"_"),s=queryAll("img",e).map((e=>{const t=e.getAttribute("downloadName"),r=e.getAttribute("downloadUrl");if(t&&r)return e.src="./"+formatName(t),{name:t,downloadUrl:r};const o=e.getAttribute([].concat(n.lazyKey||[]).find((t=>e.getAttribute(t)))||"src").replace(/\?$/,""),a=getExt(o),i=l+"/"+md5(o)+(a?"."+a:"");return e.src="./"+formatName(i),{name:i,downloadUrl:o}})),m=setInfo({title:c,origin:o,author:getText(t.userName),home:getUrl(location.origin,getAttribute("href",t.userLink)),tag:a.tag,description:e.innerText.replace(/^([\n\s]+)/g,"").replace(/\n/g," ").slice(0,50)+"..."},i.tpl),d=html2markdown(m+getMarkdown(e),{}),p=formatCopyRight({title:c,url:location.href},i),g=await r("formatContent",{markdownBody:e,markdownDoc:d});return s.push({name:l+".md",content:`${g&&"string"==typeof g?g:d}${p}`}),{fileName:c,files:s}};export const downloadMarkdown=async(...e)=>{const t={},{options:n,hook:r}=formatParams(...e),{selectors:o,el:a=document}=n,i=getContainer(a),c={container:i,options:n},l=async(e,n)=>await exec(r[e],t,Object.assign(c,n instanceof Object?n:{}))instanceof Object;if(n.context=t,await l("beforeExtract"))return exec();const s=formatMarkdownBody(i,o,n);if(await l("extract",{markdownBody:s}))return exec();const{fileName:m,files:d}=await extract(s,o,n,exec);return await l("afterExtract",{fileName:m,files:d})?exec():{type:"download",fileName:m,files:d}};export default downloadMarkdown;